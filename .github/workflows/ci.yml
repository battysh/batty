name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings

jobs:
  changes:
    name: Change Scope
    runs-on: ubuntu-latest
    outputs:
      docs: ${{ steps.filter.outputs.docs }}
      non_docs: ${{ steps.filter.outputs.non_docs }}
      docs_only: ${{ steps.docs_only.outputs.value }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docs:
              - 'docs/**'
              - 'mkdocs.yml'
              - 'scripts/generate-docs.sh'
              - '.github/workflows/docs-publish.yml'
            non_docs:
              - '**'
              - '!docs/**'
              - '!mkdocs.yml'
              - '!scripts/generate-docs.sh'
              - '!.github/workflows/docs-publish.yml'

      - id: docs_only
        shell: bash
        run: |
          if [ "${{ steps.filter.outputs.docs }}" = "true" ] && [ "${{ steps.filter.outputs.non_docs }}" != "true" ]; then
            echo "value=true" >> "$GITHUB_OUTPUT"
          else
            echo "value=false" >> "$GITHUB_OUTPUT"
          fi

  check:
    name: Rust Checks (${{ matrix.os }})
    needs: changes
    if: github.event_name == 'push' || needs.changes.outputs.non_docs == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - uses: Swatinem/rust-cache@v2

      - name: Lint
        run: make lint

      - name: Build
        run: cargo build

      - name: Test
        run: cargo test

  coverage:
    name: Code Coverage
    needs: changes
    if: github.event_name == 'push' || needs.changes.outputs.non_docs == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage
        run: cargo tarpaulin --out xml --output-dir coverage/ --skip-clean

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage/cobertura.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  docs:
    name: Docs Quality
    needs: changes
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install docs dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install mkdocs-material mdformat mdformat-gfm

      - name: Refresh generated references
        run: ./scripts/generate-docs.sh

      - name: Markdown format check
        shell: bash
        run: |
          mapfile -t doc_files < <(find docs -name '*.md' | sort)
          mdformat --check "${doc_files[@]}"

      - name: Markdown lint check
        run: npx --yes markdownlint-cli2 "docs/**/*.md"

      - name: Internal link audit
        run: mkdocs build --strict

      - name: Verify generated docs are committed
        run: git diff --exit-code -- docs/reference/cli.md docs/reference/config.md
