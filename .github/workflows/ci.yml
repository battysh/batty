name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings

jobs:
  changes:
    name: Change Scope
    runs-on: ubuntu-latest
    outputs:
      docs: ${{ steps.filter.outputs.docs }}
      non_docs: ${{ steps.filter.outputs.non_docs }}
      docs_only: ${{ steps.docs_only.outputs.value }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docs:
              - 'docs/**'
              - 'mkdocs.yml'
              - 'scripts/generate-docs.sh'
              - '.github/workflows/docs-publish.yml'
            non_docs:
              - '**'
              - '!docs/**'
              - '!mkdocs.yml'
              - '!scripts/generate-docs.sh'
              - '!.github/workflows/docs-publish.yml'

      - id: docs_only
        shell: bash
        run: |
          if [ "${{ steps.filter.outputs.docs }}" = "true" ] && [ "${{ steps.filter.outputs.non_docs }}" != "true" ]; then
            echo "value=true" >> "$GITHUB_OUTPUT"
          else
            echo "value=false" >> "$GITHUB_OUTPUT"
          fi

  check:
    name: Rust Checks (${{ matrix.os }})
    needs: changes
    if: github.event_name == 'push' || needs.changes.outputs.non_docs == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - uses: Swatinem/rust-cache@v2

      - name: Install system dependencies
        run: |
          if [ "$RUNNER_OS" = "Linux" ]; then
            sudo apt-get update && sudo apt-get install -y tmux
          elif [ "$RUNNER_OS" = "macOS" ]; then
            brew install tmux
          fi
        shell: bash

      - name: Install kanban-md
        run: |
          KMD_VERSION="0.32.2"
          if [ "$RUNNER_OS" = "Linux" ]; then
            ARCH="linux_amd64"
          elif [ "$RUNNER_OS" = "macOS" ]; then
            ARCH="darwin_arm64"
          fi
          curl -sL "https://github.com/antopolskiy/kanban-md/releases/download/v${KMD_VERSION}/kanban-md_${KMD_VERSION}_${ARCH}.tar.gz" | sudo tar xz -C /usr/local/bin kanban-md
        shell: bash

      - name: Lint
        run: make lint

      - name: Build
        run: cargo build

      - name: Test
        run: >-
          cargo test --
          --skip tmux::tests::create_session
          --skip tmux::tests::create_window
          --skip tmux::tests::capture_pane
          --skip tmux::tests::send_keys
          --skip tmux::tests::session_with_short
          --skip orchestrator::tests::status_bar
          --skip orchestrator::tests::handle_prompt_tier2
          --skip orchestrator::tests::harness_direct_reply
          --skip tier2::tests::call_supervisor
          --skip work::phase_worktree::tests::prepare_agent_worktrees_creates

  coverage:
    name: Code Coverage
    needs: changes
    if: github.event_name == 'push' || needs.changes.outputs.non_docs == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y tmux

      - name: Install kanban-md
        run: |
          KMD_VERSION="0.32.2"
          if [ "$RUNNER_OS" = "Linux" ]; then
            ARCH="linux_amd64"
          elif [ "$RUNNER_OS" = "macOS" ]; then
            ARCH="darwin_arm64"
          fi
          curl -sL "https://github.com/antopolskiy/kanban-md/releases/download/v${KMD_VERSION}/kanban-md_${KMD_VERSION}_${ARCH}.tar.gz" | sudo tar xz -C /usr/local/bin kanban-md
        shell: bash

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage
        run: >-
          cargo tarpaulin --out xml --output-dir coverage/ --skip-clean
          --
          --skip tmux::tests::create_session
          --skip tmux::tests::create_window
          --skip tmux::tests::capture_pane
          --skip tmux::tests::send_keys
          --skip tmux::tests::session_with_short
          --skip orchestrator::tests::status_bar
          --skip orchestrator::tests::handle_prompt_tier2
          --skip orchestrator::tests::harness_direct_reply
          --skip tier2::tests::call_supervisor
          --skip work::phase_worktree::tests::prepare_agent_worktrees_creates

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage/cobertura.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  docs:
    name: Docs Quality
    needs: changes
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install docs dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install "mkdocs>=1.6,<2" mkdocs-material mdformat mdformat-gfm

      - name: Refresh generated references
        run: ./scripts/generate-docs.sh

      - name: Markdown format check
        shell: bash
        run: |
          mapfile -t doc_files < <(find docs -name '*.md' | sort)
          mdformat --check "${doc_files[@]}"

      - name: Markdown lint check
        run: npx --yes markdownlint-cli2 "docs/**/*.md"

      - name: Internal link audit
        run: mkdocs build --strict

      - name: Verify generated docs are committed
        run: git diff --exit-code -- docs/reference/cli.md docs/reference/config.md
